<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Analysis | –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/index.css">
    <style>
        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .username-text {
            margin-right: 10px;
            font-weight: 500;
        }
        #userInfo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <a href="/" style="text-decoration: none; color: inherit;">Semantic Analysis</a>
        </div>
        <div class="auth-buttons">
            <div id="authButtons">
                <a href="#" id="showLoginBtn" class="btn-secondary">–í–æ–π—Ç–∏</a>
                <a href="#" id="showRegisterBtn" class="btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </div>
            <div id="userInfo" class="hidden">
                <span id="usernameDisplay" class="username-text"></span>
                <a href="#" id="logoutBtn" class="btn-secondary">–í—ã–π—Ç–∏</a>
                <button id="theme-toggle" class="btn-theme">üåô</button>
            </div>
        </div>
    </header>
    
    <main>
        <section class="hero">
            <div class="container">
                <!-- –ë–ª–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                <div class="auth-container" id="authSection">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="auth-title" id="authTitle">–í—Ö–æ–¥</h3>
                            
                            <form id="loginForm" class="auth-form">
                                <div class="form-group">
                                    <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="off">
                                </div>
                                <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                                <button type="button" class="btn btn-link" id="toggleRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                            </form>
                            
                            <form id="registerForm" class="auth-form hidden">
                                <div class="form-group">
                                    <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <input type="email" id="regEmail" placeholder="Email" required autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <input type="password" id="regConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required autocomplete="off">
                                </div>
                                <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                                <button type="button" class="btn btn-link" id="toggleLogin">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</button>
                            </form>
                            
                            <div class="alert alert-danger hidden" id="authError"></div>
                        </div>
                    </div>
                </div>
        
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏) -->
                <div id="mainContent" class="hidden">
                    <div class="analytics-container">
                        <div class="card">
                            <div class="card-body">
                                
                                <form id="chatForm" class="analytics-form">
                                    <div class="form-group">
                                        <label for="chat_name">–ò–º—è —á–∞—Ç–∞ –∏–ª–∏ ID:</label>
                                        <input type="text" id="chat_name" required 
                                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @durov –∏–ª–∏ 123456789">
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                            <input type="date" id="start_date">
                                        </div>
                                        <div class="form-group">
                                            <label for="end_date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                                            <input type="date" id="end_date">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="min_word_length">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–ª–æ–≤–∞:</label>
                                        <input type="number" id="min_word_length" value="5" min="1">
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </form>

                                <div class="progress-container" id="progressContainer">
                                    <div class="progress-bar" id="progressBar"> </div>
                                </div>

                                <div class="alert alert-danger" id="errorAlert"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>&copy; 2025 Semantic Analysis. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        </footer>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-theme');
            themeToggle.textContent = '‚òÄÔ∏è';
        }
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Auth elements
        const authSection = document.getElementById('authSection');
        const mainContent = document.getElementById('mainContent');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const toggleRegister = document.getElementById('toggleRegister');
        const toggleLogin = document.getElementById('toggleLogin');
        const authError = document.getElementById('authError');
        const logoutBtn = document.getElementById('logoutBtn');
        const authTitle = document.getElementById('authTitle');
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const authButtons = document.getElementById('authButtons');
        const userInfo = document.getElementById('userInfo');
        const usernameDisplay = document.getElementById('usernameDisplay');

        // Check URL parameters for form type
        const urlParams = new URLSearchParams(window.location.search);
        const formType = urlParams.get('form');
        
        // Show appropriate form based on URL parameter
        if (formType === 'register') {
            showRegisterForm();
        } else {
            showLoginForm();
        }

        function showLoginForm() {
            console.log('Showing login form');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authTitle.textContent = '–í—Ö–æ–¥';
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('regUsername').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
        }

        function showRegisterForm() {
            console.log('Showing register form');
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Auth functions
        async function login(username, password) {
            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch('/auth/token', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.access_token);
                    checkAuth();
                } else {
                    showAuthError('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                }
            } catch (error) {
                showAuthError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Login error:', error);
            }
        }
        
        async function register(username, email, password, confirmPassword) {
            try {
                const response = await fetch('/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        confirm_password: confirmPassword,
                        is_active: true
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'success');
                    showLoginForm();
                } else {
                    showAuthError(data.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                    console.error('Registration error:', data);
                }
            } catch (error) {
                showAuthError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Registration error:', error);
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            checkAuth();
        }
        
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                showAuth();
                return;
            }
            
            try {
                const response = await fetch('/protected-route', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showMainContent();
                } else {
                    localStorage.removeItem('token');
                    showAuth();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAuth();
            }
        }
        
        function showAuth() {
            authSection.classList.remove('hidden');
            mainContent.classList.add('hidden');
            authButtons.style.display = 'flex';
            userInfo.style.display = 'none';
        }
        
        function showMainContent() {
            authSection.classList.add('hidden');
            mainContent.classList.remove('hidden');
            authButtons.style.display = 'none';
            userInfo.style.display = 'flex';
            // Get username from token
            const token = localStorage.getItem('token');
            if (token) {
                const payload = JSON.parse(atob(token.split('.')[1]));
                usernameDisplay.textContent = payload.sub;
            }
        }
        
        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden', 'alert-success');
            authError.classList.add('alert-danger');
        }
        
        function showAuthMessage(message, type = 'success') {
            authError.textContent = message;
            authError.classList.remove('hidden', 'alert-danger');
            authError.classList.add('alert-' + type);
        }
        
        // Event listeners for auth
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            login(username, password);
        });
        
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showAuthError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            register(username, email, password, confirmPassword);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ö
        if (toggleRegister) {
            toggleRegister.addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterForm();
            });
        }
        
        if (toggleLogin) {
            toggleLogin.addEventListener('click', function(e) {
                e.preventDefault();
                showLoginForm();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ —à–∞–ø–∫–µ
        if (showLoginBtn) {
            showLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showLoginForm();
                authSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
            });
        }
        
        if (showRegisterBtn) {
            showRegisterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterForm();
                authSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
            });
        }
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }
        
        // Check auth on load
        checkAuth();

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –∞–Ω–∞–ª–∏–∑–∞
        const chatForm = document.getElementById('chatForm');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const errorAlert = document.getElementById('errorAlert');

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const formData = {
                chat_name: document.getElementById('chat_name').value,
                start_date: document.getElementById('start_date').value || null,
                end_date: document.getElementById('end_date').value || null,
                min_word_length: document.getElementById('min_word_length').value
            };

            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                progressContainer.style.display = 'block';
                errorAlert.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';

                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket
                const ws = new WebSocket(`ws://${window.location.host}/ws`);
                
                ws.onopen = () => {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ WebSocket
                    ws.send(JSON.stringify(formData));
                };

                ws.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.status === 'error') {
                        errorAlert.textContent = data.message;
                        errorAlert.style.display = 'block';
                        progressContainer.style.display = 'none';
                    } 
                    else if (data.status === 'completed') {
                        // –ö–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                        window.location.href = `/get_history?filename=${data.filename}&min_word_length=${formData.min_word_length}`;
                    }
                    else if (data.progress) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                        progressBar.style.width = `${data.progress}%`;
                        progressBar.textContent = `${Math.round(data.progress)}%`;
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    errorAlert.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                    errorAlert.style.display = 'block';
                    progressContainer.style.display = 'none';
                };

            } catch (error) {
                console.error('Error:', error);
                errorAlert.textContent = error.message;
                errorAlert.style.display = 'block';
                progressContainer.style.display = 'none';
            }
        });
    });
    </script>
</body>
</html>