<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты анализа | Semantic Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/welcome.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stats-content {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .plot-container {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .plot-img {
            max-width: 100%;
            height: auto;
        }
        .stat-card {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .history-item:hover {
            background-color: #f8f9fa;
        }
        .telegram-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .telegram-status.available {
            background-color: #d4edda;
            color: #155724;
        }
        .telegram-status.unavailable {
            background-color: #f8d7da;
            color: #721c24;
        }
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Стили для карточек пользователей */
        .user-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .user-card[data-role="admin"]::before {
            background-color: #dc3545;
        }

        .user-card[data-role="user"]::before {
            background-color: #28a745;
        }

        .user-card[data-role="userplus"]::before {
            background-color: #007bff;
        }

        .user-card[data-role="none"]::before {
            background-color: #6c757d;
        }
        
        .user-info {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 15px;
            padding-left: 10px;
        }

        .user-info .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .role-badge.admin {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .role-badge.user {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .role-badge.userplus {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .role-badge.none {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        
        .user-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .user-info p {
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .role-select {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .permissions-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .permissions-list h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .permission-badge {
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 5px 10px;
            font-size: 0.9em;
        }

        .btn-danger {
            width: 100%;
            margin-top: 10px;
        }

        /* Dark theme styles */
        body.dark-theme .user-card {
            background: #2d2d2d;
            border-color: #444;
        }

        body.dark-theme .user-info {
            border-color: #444;
        }

        body.dark-theme .user-info h3 {
            color: #ffffff;
        }

        body.dark-theme .user-info p {
            color: #adb5bd;
        }

        body.dark-theme .role-select,
        body.dark-theme .permissions-list {
            background: #1a1a1a;
        }

        body.dark-theme .permissions-list h4 {
            color: #ffffff;
        }

        body.dark-theme .form-select {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #444;
        }

        body.dark-theme .form-select:focus {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        body.dark-theme .history-item:hover {
            background-color: #333 !important;
            color: #fff !important;
        }

        body.dark-theme .role-badge {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Admin panel styles */
        .admin-content {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .user-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .user-card[data-role="admin"]::before {
            background-color: #dc3545;
        }

        .user-card[data-role="user"]::before {
            background-color: #28a745;
        }

        .user-card[data-role="userplus"]::before {
            background-color: #007bff;
        }

        .user-card[data-role="none"]::before {
            background-color: #6c757d;
        }
        
        .user-info {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 15px;
            padding-left: 10px;
        }

        .user-info .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .role-badge.admin {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .role-badge.user {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .role-badge.userplus {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .role-badge.none {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        
        .user-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .user-info p {
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .role-select {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .permissions-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .permissions-list h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* Dark theme styles for admin panel */
        body.dark-theme .user-card {
            background: #2d2d2d;
            border-color: #444;
        }
        
        body.dark-theme .user-info {
            border-color: #444;
        }
        
        body.dark-theme .user-info h3 {
            color: #ffffff;
        }
        
        body.dark-theme .user-info p {
            color: #adb5bd;
        }

        body.dark-theme .role-badge {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        body.dark-theme .role-select,
        body.dark-theme .permissions-list {
            background: #1a1a1a;
        }

        /* Custom modal styles */
        .modal-dialog {
            max-width: none !important;
            width: 1200px !important;
            min-width: 1200px !important;
        }
        .modal-content {
            width: 100% !important;
            min-width: 100% !important;
            height: 800px !important;
        }
        @media (max-width: 1300px) {
            .modal-dialog {
                width: 98vw !important;
                min-width: 98vw !important;
            }
            .modal-content {
                width: 100vw !important;
                min-width: 100vw !important;
            }
        }

        .modal-body {
            height: calc(100% - 120px); /* Вычитаем высоту header и footer */
            overflow-y: auto;
        }

        .modal-header, .modal-footer {
            width: 100%;
        }

        .tab-content {
            height: 100%;
        }

        .tab-pane {
            height: 100%;
        }

        #analysisForm, #changePasswordForm {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .history-list {
            height: 100%;
            overflow-y: auto;
        }

        /* Dark theme styles */
        body.dark-theme {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        body.dark-theme .plot-container,
        body.dark-theme .stat-card {
            background: #2d2d2d;
            color: #ffffff;
        }

        body.dark-theme .card {
            background: #2d2d2d;
            color: #ffffff;
        }

        body.dark-theme .modal-content {
            background: #2d2d2d;
            color: #ffffff;
        }

        body.dark-theme .nav-tabs .nav-link {
            color: #ffffff;
        }

        body.dark-theme .nav-tabs .nav-link.active {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #dee2e6 #dee2e6 #2d2d2d;
        }

        body.dark-theme .form-control {
            background-color: #1a1a1a;
            color: #ffffff;
            border-color: #444;
        }

        body.dark-theme .form-control:focus {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        body.dark-theme .history-item:hover {
            background-color: #333 !important;
            color: #fff !important;
        }

        /* Password change form styles */
        #changePasswordForm {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        #changePasswordForm .form-label {
            color: #2c3e50;
            font-weight: 500;
        }
        
        #changePasswordForm .form-control {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
        }
        
        #changePasswordForm .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        /* Dark theme styles for password form */
        body.dark-theme #changePasswordForm .form-label {
            color: #ffffff;
        }
        
        body.dark-theme #changePasswordForm .form-control {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #444;
        }
        
        body.dark-theme #changePasswordForm .form-control:focus {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #80bdff;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <a href="/" style="text-decoration: none; color: inherit;">Semantic Analysis</a>
        </div>
        <div class="auth-buttons">
            <a href="/welcome" class="btn-secondary">Назад</a>
            <a href="/download_pdf" class="btn-secondary">Скачать PDF</a>
            <a href="#" class="btn-secondary" data-bs-toggle="modal" data-bs-target="#changeDataModal">Настройки</a>
            <button id="theme-toggle" class="btn-theme">🌙</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="stats-content">
        <h1 class="text-center mb-4">Результаты анализа</h1>
        <div class="telegram-status {{ 'available' if telegram_available else 'unavailable' }}">
            <p class="mb-0">
                {% if telegram_available %}
                    Telegram подключен и доступен
                {% else %}
                    Telegram не подключен. Некоторые функции могут быть недоступны
                {% endif %}
            </p>
        </div>

        <div class="stat-card">
            <h3>Общая статистика</h3>
            <p>Всего слов: {{ word_count }}</p>
        </div>

        <!-- Графики -->
        <div class="row mt-4">
            <div class="col-12">
                <h3>Анализ сообщений</h3>
                <div class="row">
                    <!-- График 1: Активность по месяцам и дням -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Активность по месяцам и дням</h5>
                                <img src="data:image/png;base64,{{ plot0 }}" class="img-fluid" alt="Активность по месяцам и дням">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 2: Распределение сообщений по часам -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Распределение сообщений по часам суток</h5>
                                <img src="data:image/png;base64,{{ plot1 }}" class="img-fluid" alt="Распределение сообщений по часам">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 3: Распределение длины сообщений -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Распределение длины сообщений</h5>
                                <img src="data:image/png;base64,{{ plot2 }}" class="img-fluid" alt="Распределение длины сообщений">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 4: Топ-10 активных участников -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Топ-10 самых активных участников</h5>
                                <img src="data:image/png;base64,{{ plot3 }}" class="img-fluid" alt="Топ-10 активных участников">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 5: Облако слов -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Облако слов</h5>
                                <img src="data:image/png;base64,{{ plot4 }}" class="img-fluid" alt="Облако слов">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 6: Эмоциональный окрас -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Эмоциональный окрас сообщений</h5>
                                <img src="data:image/png;base64,{{ plot5 }}" class="img-fluid" alt="Эмоциональный окрас">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 7: Распределение длины слов -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Распределение длины слов</h5>
                                <img src="data:image/png;base64,{{ plot6 }}" class="img-fluid" alt="Распределение длины слов">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 8: Активность по дням недели -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Активность по дням недели</h5>
                                <img src="data:image/png;base64,{{ plot7 }}" class="img-fluid" alt="Активность по дням недели">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 9: Средняя длина сообщений -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Средняя длина сообщений по отправителям</h5>
                                <img src="data:image/png;base64,{{ plot8 }}" class="img-fluid" alt="Средняя длина сообщений">
                            </div>
                        </div>
                    </div>
                    
                    <!-- График 10: Активность по времени суток -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Активность по времени суток</h5>
                                <img src="data:image/png;base64,{{ plot9 }}" class="img-fluid" alt="Активность по времени суток">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Semantic Analysis. Все права защищены.</p>
    </footer>

    <!-- Модальное окно для изменения параметров -->
    <div class="modal fade" id="changeDataModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Настройки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="true">Анализ</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">История</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab" aria-controls="password" aria-selected="false">Смена пароля</button>
                        </li>
                        <li class="nav-item" role="presentation" id="adminTab" style="display: none;">
                            <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">Админ панель</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
                            <form id="analysisForm">
                                <div class="mb-3">
                                    <label for="min_word_length" class="form-label">Минимальная длина слова</label>
                                    <input type="number" class="form-control" id="min_word_length" value="5" min="1">
                                </div>
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">Начальная дата</label>
                                    <input type="date" class="form-control" id="start_date">
                                </div>
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">Конечная дата</label>
                                    <input type="date" class="form-control" id="end_date">
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                            <div class="history-list" id="historyList">
                                <!-- Здесь будет список истории -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Текущий пароль</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">Новый пароль</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmNewPassword" class="form-label">Подтвердите новый пароль</label>
                                    <input type="password" class="form-control" id="confirmNewPassword" required>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                            <div class="admin-content">
                                <h2 class="text-center mb-4">Управление пользователями</h2>
                                <div id="usersList">
                                    <!-- Здесь будет список пользователей -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="applyChanges">Применить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        // Функция для изменения роли пользователя
        async function changeUserRole(userId, newRole) {
            try {
                // Отправляем запрос на изменение роли
                const response = await fetch(`/auth/users/${userId}?role_id=${newRole}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Не удалось изменить роль пользователя');
                }

                // Получаем обновленные данные пользователя
                const updatedUserResponse = await fetch(`/auth/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!updatedUserResponse.ok) {
                    throw new Error('Не удалось получить обновленные данные пользователя');
                }

                const updatedUser = await updatedUserResponse.json();
                
                // Находим карточку пользователя
                const userCard = document.querySelector(`[data-user-id="${userId}"]`);
                if (userCard) {
                    // Обновляем атрибут data-role
                    userCard.setAttribute('data-role', updatedUser.role?.name?.toLowerCase() || 'none');
                    
                    // Обновляем бейдж роли
                    const roleBadge = userCard.querySelector('.role-badge');
                    if (roleBadge) {
                        roleBadge.className = `role-badge ${updatedUser.role?.name?.toLowerCase() || 'none'}`;
                        roleBadge.textContent = updatedUser.role?.name || 'Нет роли';
                    }
                    
                    // Обновляем список разрешений
                    const permissionsList = userCard.querySelector('.permissions-list div');
                    if (permissionsList) {
                        permissionsList.innerHTML = updatedUser.role?.permissions ? 
                            updatedUser.role.permissions.map(p => 
                                `<span class="badge bg-primary permission-badge">${p.name}</span>`
                            ).join('') : 
                            'Нет разрешений';
                    }
                    
                    // Обновляем выбранное значение в селекте
                    const roleSelect = userCard.querySelector(`#role-${userId}`);
                    if (roleSelect) {
                        roleSelect.value = updatedUser.role_id;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }

        // Функция для загрузки списка пользователей
        async function loadUsers() {
            try {
                const response = await fetch('/auth/users/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Недостаточно прав для просмотра пользователей');
                }
                
                const users = await response.json();
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    const roleName = user.role ? user.role.name.toLowerCase() : 'none';
                    userCard.setAttribute('data-role', roleName);
                    userCard.setAttribute('data-user-id', user.id);
                    
                    const roleBadgeClass = `role-badge ${roleName}`;
                    const roleDisplayName = user.role ? user.role.name : 'Без роли';
                    
                    userCard.innerHTML = `
                        <div class="user-info">
                            <h3>
                                ${user.username}
                                <span class="${roleBadgeClass}">${roleDisplayName}</span>
                            </h3>
                            <p>Email: ${user.email}</p>
                        </div>
                        <div class="role-select">
                            <label for="role-${user.id}" class="form-label">Изменить роль:</label>
                            <select class="form-select" id="role-${user.id}" onchange="changeUserRole(${user.id}, this.value)">
                                <option value="1" ${user.role_id === 1 ? 'selected' : ''}>Admin</option>
                                <option value="2" ${user.role_id === 2 ? 'selected' : ''}>User</option>
                                <option value="3" ${user.role_id === 3 ? 'selected' : ''}>UserPlus</option>
                            </select>
                        </div>
                        <div class="permissions-list">
                            <h4>Разрешения:</h4>
                            <div>
                                ${user.role && user.role.permissions ? 
                                    user.role.permissions.map(p => 
                                        `<span class="badge bg-primary permission-badge">${p.name}</span>`
                                    ).join('') : 
                                    'Нет разрешений'}
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning w-100 mb-2" onclick="resetUserPassword(${user.id})">Сбросить пароль</button>
                            <button class="btn btn-danger w-100" onclick="deleteUser(${user.id})">Удалить пользователя</button>
                        </div>
                    `;
                    usersList.appendChild(userCard);
                });
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                alert(error.message);
            }
        }

        // Функция для сброса пароля пользователя
        async function resetUserPassword(userId) {
            const newPassword = prompt('Введите новый пароль:');
            if (!newPassword) return;

            try {
                const response = await fetch(`/auth/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ new_password: newPassword })
                });
                
                if (!response.ok) {
                    throw new Error('Не удалось сбросить пароль пользователя');
                }
                
                alert('Пароль успешно сброшен');
            } catch (error) {
                console.error('Ошибка сброса пароля:', error);
                alert(error.message);
            }
        }

        // Функция для удаления пользователя
        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;

            try {
                const response = await fetch(`/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Не удалось удалить пользователя');
                }
                
                // Перезагружаем список пользователей
                loadUsers();
            } catch (error) {
                console.error('Ошибка удаления пользователя:', error);
                alert(error.message);
            }
        }

        // Получаем ID текущего пользователя при загрузке страницы
        let currentUserId = null;
        async function getCurrentUserId() {
            try {
                const response = await fetch('/auth/users/me', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUserId = user.id;
                }
            } catch (error) {
                console.error('Ошибка получения информации о текущем пользователе:', error);
            }
        }

        // Загружаем ID текущего пользователя при загрузке страницы
        document.addEventListener('DOMContentLoaded', getCurrentUserId);

        // Функция для проверки прав администратора
        async function checkAdminAccess() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('adminTab').style.display = 'none';
                    return;
                }
                
                const response = await fetch('/auth/users/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    document.getElementById('adminTab').style.display = 'block';
                    // Загружаем список пользователей при открытии вкладки админ-панели
                    document.getElementById('admin-tab').addEventListener('shown.bs.tab', loadUsers);
                } else {
                    document.getElementById('adminTab').style.display = 'none';
                }
            } catch (error) {
                console.error('Ошибка проверки прав доступа:', error);
                document.getElementById('adminTab').style.display = 'none';
            }
        }

        // Проверяем права администратора при загрузке страницы и при открытии модального окна
        document.addEventListener('DOMContentLoaded', checkAdminAccess);
        document.getElementById('changeDataModal').addEventListener('show.bs.modal', checkAdminAccess);

        // Функция для загрузки истории
        async function loadHistory() {
            try {
                const response = await fetch('/get_history_list');
                const history = await response.json();
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>${new Date(item.timestamp).toLocaleString()}</span>
                            <span>${item.filename}</span>
                        </div>
                    `;
                    div.onclick = () => loadHistoryItem(item.id);
                    historyList.appendChild(div);
                });
            } catch (error) {
                console.error('Ошибка загрузки истории:', error);
            }
        }

        // Функция для загрузки элемента истории
        async function loadHistoryItem(id) {
            try {
                const response = await fetch(`/load_history/${id}`);
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Ошибка загрузки элемента истории:', error);
            }
        }

        // Обработчик изменения данных
        document.getElementById('applyChanges').addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-pane.active');
            
            if (activeTab.id === 'analysis') {
                const minWordLength = document.getElementById('min_word_length').value;
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;

                try {
                    const response = await fetch('/update_analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            min_word_length: parseInt(minWordLength),
                            start_date: startDate,
                            end_date: endDate
                        })
                    });

                    if (response.ok) {
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Ошибка обновления данных:', error);
                }
            } else if (activeTab.id === 'password') {
                const email = document.getElementById('email').value;
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;

                if (newPassword !== confirmNewPassword) {
                    alert('Новые пароли не совпадают');
                    return;
                }

                try {
                    const response = await fetch('/change_password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    if (response.ok) {
                        alert('Пароль успешно изменен');
                        window.location.reload();
                    } else {
                        const data = await response.json();
                        alert(data.detail || 'Ошибка при смене пароля');
                    }
                } catch (error) {
                    console.error('Ошибка смены пароля:', error);
                    alert('Произошла ошибка при смене пароля');
                }
            }
        });

        // Загружаем историю при открытии вкладки истории
        document.getElementById('history-tab').addEventListener('shown.bs.tab', loadHistory);

        // Удаляем токен из localStorage при выходе из аккаунта
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.reload();
        });
    </script>
</body>
</html>